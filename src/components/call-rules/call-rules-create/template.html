<pbx-form [background]="true"
          [confirm]="{value: 'Save', buttonType: 'success', inactive: saving}"
          [decline]="{value: 'Cancel', buttonType: 'cancel'}"
          (onConfirm)="save()"
          (onDecline)="cancel()"
>
    <pbx-loader *ngIf="loading"></pbx-loader>
        <form [formGroup]="callRulesForm" class="call-rules-create" *ngIf="!loading">
            <div class="call-rules-create_row">
                <h3>General</h3>
            </div>

            <pbx-input name="Enable Rule"
                       key="enabled"
                       [checkbox]="true"
                       [form]="true"
                       [object]="callRulesForm"
                       [(errors)]="service.errors"
                       [validationHost]="validationHost"
                       >
            </pbx-input>
            <pbx-input name="Rule Name"
                       key="name"
                       [required]="true"
                       [form]="true"
                       [object]="callRulesForm"
                       [(errors)]="service.errors"
                       [validationHost]="validationHost"
                       >
            </pbx-input>
            <pbx-input name="Description"
                       key="description"
                       [form]="true"
                       [object]="callRulesForm"
                       [(errors)]="service.errors"
                       [validationHost]="validationHost"
                       >
            </pbx-input>
            <pbx-input *ngIf="!editMode"
                       name="Phone number"
                       key="sipId"
                       [placeholder]="'[choose one]'"
                       [required]="true"
                       [form]="true"
                       [(object)]="callRulesForm"
                       [options]="numbers"
                       displayKey="phoneNumber"
                       [editable]="true"
                       [(errors)]="service.errors"
                       [validationHost]="validationHost"
                       [(objectView)]="selectedNumber"
                       (onSelect)="selectNumber($event)"
                       >
            </pbx-input>

            <ng-container *ngIf="!callRulesForm.get('sipId').value">
                <div class="call-rules-create_row">
                    <label></label>
                    <div><p>Please note: you must select a phone number before creating a new action.</p></div>
                </div>
            </ng-container>

            <pbx-loader *ngIf="loadingStuff"></pbx-loader>

            <ng-container *ngIf="!loadingStuff && callRulesForm.get('sipId').value">
                <div class="call-rules-create_row">
                    <h3>Options</h3>
                </div>

                <pbx-input name="Action"
                           [required]="true"
                           [placeholder]="'[choose one]'"
                           [form]="true"
                           [formKey]="getActionFormKey(0)"
                           [(object)]="callRulesForm"
                           [options]="actionsList"
                           displayKey="code"
                           [editable]="true"
                           [(errors)]="service.errors"
                           validationKey="ruleActions"
                           [validationHost]="validationHost"
                           [(objectView)]="selectedActions[0]"
                           (onSelect)="selectAction($event)"
                           >
                </pbx-input>

                <ng-container formArrayName="ruleActions">
                    <ng-container *ngFor="let action of actionsControls.controls; let i = index;" [formGroupName]="i">
                        <ng-container [ngSwitch]="selectedActions[i].id">
                            <!-- Redirect to extension number -->
                            <ng-template [ngSwitchCase]="1" let>
                                <pbx-input name="Extension number"
                                           key="parameter"
                                           [required]="true"
                                           [placeholder]="'[choose one]'"
                                           [form]="true"
                                           [object]="action"
                                           [options]="sipInners"
                                           displayKey="phoneNumber"
                                           [editable]="true"
                                           [(errors)]="service.errors"
                                           [errorKey]="'ruleActions.new_' + i + '.parameter'"
                                           [validationHost]="validationHost"
                                           [(objectView)]="selectedSipInners[i]"
                                           (onSelect)="selectSipInner(i, $event)"
                                           >
                                </pbx-input>

                                <pbx-input name="If I do not answer call within"
                                           description="seconds"
                                           key="timeout"
                                           [form]="true"
                                           [object]="action"
                                           [(errors)]="service.errors"
                                           [errorKey]="'ruleActions.new_' + i + '.timeout'"
                                           [validationHost]="validationHost"
                                           inputClass="time"
                                           inputCenter="true"
                                           [hVMessageOffset]="-94"
                                           >
                                </pbx-input>

                                <call-rules-time-rules [action]="action"
                                                       [form]="form"
                                                       [validationHost]="validationHost"
                                                       (onChange)="onTimeRuleChange(i, $event)">
                                </call-rules-time-rules>
                            </ng-template>
                            <ng-template [ngSwitchCase]="2">
                                <pbx-input name="External number"
                                           key="parameter"
                                           [form]="true"
                                           [required]="true"
                                           [object]="action">
                                </pbx-input>

                                <pbx-input name="If I do not answer call within"
                                           description="seconds"
                                           inputClass="time"
                                           key="timeout"
                                           [errorKey]="'ruleActions.new_' + i + '.timeout'"
                                           [form]="true"
                                           [(errors)]="service.errors"
                                           [object]="action">
                                </pbx-input>

                                <call-rules-time-rules [action]="action"
                                                       [form]="form"
                                                       [validationHost]="validationHost"
                                                       (onChange)="onTimeRuleChange(i, $event)">
                                </call-rules-time-rules>

                            </ng-template>
                            <ng-template [ngSwitchCase]="3">

                                <pbx-input name="Queue"
                                           displayKey="name"
                                           key="parameter"
                                           placeholder="{{queues.length === 0 ? 'None' : '[choose one]'}}"
                                           [errorKey]="'ruleActions.new_' + i + '.parameter'"
                                           [form]="true"
                                           [required]="true"
                                           (onSelect)="selectQueue(i, $event)"
                                           [options]="queues"
                                           [(errors)]="service.errors"
                                           [(objectView)]="selectedQueues[i]"
                                           [object]="action"
                                           [ngClass]="queues.length > 0 ? 'class1':'class2'">
                                </pbx-input>

                                <pbx-input name="If I do not answer call within"
                                           description="seconds"
                                           inputClass="time"
                                           key="timeout"
                                           [errorKey]="'ruleActions.new_' + i + '.timeout'"
                                           [form]="true"
                                           [(errors)]="service.errors"
                                           [object]="action">
                                </pbx-input>

                                <call-rules-time-rules [action]="action"
                                                       [form]="form"
                                                       [validationHost]="validationHost"
                                                       (onChange)="onTimeRuleChange(i, $event)">
                                </call-rules-time-rules>

                            </ng-template>
                            <ng-template [ngSwitchCase]="4">
                                <div class="call-rules-create_row">
                                    <label></label>
                                    <div>
                                        <p>Terminate call</p>
                                    </div>
                                </div>
                                <!--<call-rules-timeout [value]="getTimeout(i)" (onChange)="onTimeoutChange(i, $event)"></call-rules-timeout>-->
                            </ng-template>
                            <ng-template [ngSwitchCase]="5">

                                <pbx-input name="Voice greeting"
                                           displayKey="fileName"
                                           key="parameter"
                                           [errorKey]="'ruleActions.new_' + i + '.parameter'"
                                           [form]="true"
                                           [required]="true"
                                           (onSelect)="selectFile(i, $event)"
                                           [options]="files"
                                           [(errors)]="service.errors"
                                           [(objectView)]="selectedFiles[i]"
                                           [object]="action"
                                           >
                                    <div class="greeting">
                                        <pbx-button [value]="playButtonText" buttonType="accent" (onClick)="togglePlay(i)"></pbx-button>
                                        <div class="hidden_button_wrapper">
                                            <pbx-button value="Upload" buttonType="accent" [loading]="storage.loading"></pbx-button>
                                            <input type="file" class="hidden_input" #fileInput (change)="uploadFile($event)">
                                        </div>
                                    </div>
                                </pbx-input>

                                <pbx-media-player
                                    #mediaPlayer
                                    [mediaStream]="currentMediaStream"
                                    (onGetMediaData)="getMediaData($event)"
                                    (onMediaStateChanged)="mediaStateChanged($event)"
                                    >
                                </pbx-media-player>

                                <pbx-input name="If I do not answer call within"
                                           description="seconds"
                                           inputClass="time"
                                           key="timeout"
                                           [errorKey]="'ruleActions.new_' + i + '.timeout'"
                                           [form]="true"
                                           [(errors)]="service.errors"
                                           [object]="action">
                                </pbx-input>

                                <call-rules-time-rules [action]="action"
                                                       [form]="form"
                                                       [validationHost]="validationHost"
                                                       (onChange)="onTimeRuleChange(i, $event)">
                                </call-rules-time-rules>

                            </ng-template>

                            <pbx-input *ngIf="checkNextAction(i)" name="Action"
                                       displayKey="code"
                                       [form]="true"
                                       [required]="true"
                                       [formKey]="getActionFormKey(i + 1, true)"
                                       (onSelect)="selectAction($event, i + 1)"
                                       [options]="actionsList"
                                       [(errors)]="service.errors"
                                       [(objectView)]="selectedActions[i + 1]"
                                       [(object)]="callRulesForm"
                                       [placeholder]="'[choose one]'"
                                       class="noMargin">
                                <div>
                                    <div class="icon_wrap" (click)="deleteAction(i)">
                                        <svg-icon src="../../assets/icons/_middle/cancel_delete_12px.svg"></svg-icon>
                                    </div>
                                </div>
                            </pbx-input>
                        </ng-container>
                    </ng-container>
                </ng-container>
            </ng-container>
        </form>
</pbx-form>
<pbx-modal [modalEx]="storage.modalUpload" 
           (onConfirmEx)="storage.doUploadAction($event)"
           (onDecline)="storage.cancelUploadAction()"
           >
</pbx-modal>
<pbx-modal [modalEx]="modalExit" 
           (onConfirmEx)="cancelConfirm()"
           >
</pbx-modal>
